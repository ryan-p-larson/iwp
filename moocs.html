<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>MOOC Enrollment</title>

	<!-- CSS -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"/>
	<link href="src/nouislider.min.css" rel="stylesheet">

	<!-- Javascript -->
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="src/nouislider.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.1.0"></script>
	<script src="https://unpkg.com/esri-leaflet@2.0.8"></script>
	<script src="https://unpkg.com/simple-statistics@4.1.0/dist/simple-statistics.js"></script>
	<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

	<!-- Styling -->
  <style>
	#mapDiv {
		width: 960px;
		height: 600px;
	}

	.legend {
		width: 150px;
	    line-height: 20px;
	    color: #000;
		background: rgba(118, 118, 118, 0.4);
		border: 1px solid rgba(255, 255, 255, 0.25);
		padding: 5px 10px 5px;
	}
	.legend i {
		width: 18px;
		height: 18px;
		float: left;
		margin-right: 8px;
		opacity: 0.7;
	}

	.filterBase {
		width: 200px;
	}
	.filter--label {
		font-weight: bold;
	}




  </style>
</head>

<body>
<div id="mapDiv"></div>

<script type="text/javascript">
// Leaflet setup
function init_map() {
	// Create Leaflet map instance
	var map = L.map('mapDiv', {
			attributionControl: false,
			zoomControl: false})
		.setView([29, -3.5], 2);
	L.esri.basemapLayer('Gray', {
			minZoom: 2,
			maxZoom: 7})
		.addTo(map);

	return map;
}
var base_style = {
	// Fill
	fillColor: '#ccc',
	fillOpacity: 0.5,
	// Stroke
	weight: 1,
	color: '#333',
	opacity: 0.5
};


// D3.js setup, using only for scales
var color_scale = d3.scaleThreshold().range(['#eff3ff','#bdd7e7','#6baed6','#3182bd','#08519c']);
var radius_scale = d3.scaleLinear().range([9, 35]);
var lookup_page = {
	"all": "All Classes",
	"poetry-and-plays-2017": 'Power of the Pen: Identities and Social Issues in Poetry and Plays',
	"fiction-and-nonfiction-2017": 'Power of the Pen: Identities and Social Issues in Fiction and Nonfiction',
	"how-writers-write-fiction-2016": 'How Writers Write Fiction 2016: Storied Women',
	"flash-write-2016": '#Flashwrite Teen Poetry',
	"how-writers-write-fiction-2015": 'How Writers Write Fiction 2015',
	"whitman-2016": 'Whitmanâ€™s Civil War: Writing and Imaging Death, Loss, and Disaster'
};
var lookup_metric = {
	'new_users': 'New Users',
	'uniq_pg_views': 'Unique Page Views',
	'pg_views': 'Total Page Views'
};

var leafletMap = init_map(), feature_layer, slider;

d3.json('data/canonical/country-classes.geojson', function(error, data) {

	// Filter those without classes
	data['features'] = data['features'].filter(d => d.properties.classes.length > 0);

	// Add features to map
	L.geoJson(data, base_style).addTo(leafletMap);

	// map each feature to a circleMarker instead
	feature_layer = data['features'].map(format_leaflet_pt);
});

// Functions
function format_leaflet_pt(d) {

	// Use turf to create points from polygons
	//var pt = turf.centroid(d.geometry, d.properties);
	var pt = turf.centerOfMass(d.geometry, d.properties);

	// flip the coordinates
	var temp_coord = [pt.geometry.coordinates[1], pt.geometry.coordinates[0]];
	pt.geometry.coordinates = temp_coord;

	var mouseover = function(e) {
			var layer = e.target;
	    layer.setStyle({weight: 3, fillOpacity: 1.0, radius: 11});
	    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
	};
	var mouseout = function(e) {
			var layer = e.target;
	    layer.setStyle({color: base_style.color, weight: 1, fillOpacity: 0.85, radius: 7});
	};

	var pt_opts = {
		// Stroke
		'color': '#333',
		'opacity': 0.75,
		'weight': 1,
		// Fill
		'fillOpacity': 0.85,
		// Other
		'radius': 7
		//'className':
	};

	// popup
	var popup_text = "<h5><strong>Country Information</strong></h5>" +
			"<b>Location: </b>" + pt.properties.country + "<br>";
	/*
	// Conditionally add link
	if (d.hasOwnProperty("link"))
			popup_text += "<b>Link: </b><a target='_blank' href='" + d.link + "'>Here.</a></b>";
	*/

	var marker = new L.circleMarker(pt.geometry.coordinates, pt_opts)
			.bindPopup(popup_text, {className: 'popup'})
			.addTo(leafletMap)
			.on('mouseover', mouseover)
			.on('mouseout', mouseout);

	console.log(d, pt)

	return marker;
}







</script>
</body>
